# VREPaaS


## Development 
This project is usgin Django rest framework. 

### Install Anaconda

Install Anaconda from these instructions: https://linuxize.com/post/how-to-install-anaconda-on-ubuntu-20-04/

Close the terminal and start a new one to activate conda.

### Create and activate conda environment

Create and activate conda environment:
```shell
conda create -n paas  python=3.9 
conda activate paas
```

#### Install tilt
Install [tilt](https://docs.tilt.dev/install.html) via conda 

```shell
conda install -c conda-forge tilt 
conda install -c conda-forge minikube 
```

#### Start Cluster

```shell
minikube start
```

#### Run tilt

```shell
tilt up
```

# Encrypt secrets 


conda install -c conda-forge git-crypt


# Deploy Webapp
```
$make deploy-app
```


# Deploy API
```
$make deploy-api
```

# API Admin
To add/reomve resources go to: https://HOST/vre-api/admin/

## Admin Credentials
The admin credentials are generated by k8s/vreapis/secreats.yaml file with the value 'superuser-passwor'
The username is hardcoded in k8s/vreapis/deplyment.yaml in the env 'DJANGO_SUPERUSER_USERNAME'



# Argo Workflows

## Generate Token
```shell
kubectl apply -f - <<EOF
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: vreapp
  namespace: argo
rules:
  - verbs:
      - get
      - watch
      - list
    apiGroups:
      - ''
    resources:
      - configmaps
      - events
  - verbs:
      - get
      - list
      - watch
      - delete
    apiGroups:
      - ''
    resources:
      - pods
  - verbs:
      - get
      - list
    apiGroups:
      - ''
    resources:
      - pods/log
  - verbs:
      - get
      - update
    apiGroups:
      - ''
    resources:
      - secrets
    resourceNames:
      - sso
  - verbs:
      - create
    apiGroups:
      - ''
    resources:
      - secrets
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - ''
    resources:
      - serviceaccounts
  - verbs:
      - get
      - list
      - watch
    apiGroups:
      - ''
    resources:
      - secrets
  - verbs:
      - watch
      - create
      - patch
    apiGroups:
      - ''
    resources:
      - events
  - verbs:
      - create
      - get
      - list
      - watch
      - update
      - patch
      - delete
    apiGroups:
      - argoproj.io
    resources:
      - eventsources
      - sensors
      - workflows
      - workfloweventbindings
      - workflowtemplates
      - cronworkflows
EOF
```shell
kubectl create sa vreapp -n argo
```
```shell
kubectl create rolebinding vreapp --role=vreapp --serviceaccount=argo:vreapp -n argo
```
```shell
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  namespace: argo
  name: vreapp.service-account-token
  annotations:
    kubernetes.io/service-account.name: vreapp
type: kubernetes.io/service-account-token
EOF
```
```shell
ARGO_TOKEN="Bearer $(kubectl get secret vreapp.service-account-token -n argo -o=jsonpath='{.data.token}' | base64 --decode)"
```

