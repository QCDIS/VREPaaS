# VREPaaS


## Development 
This project is usgin Django rest framework. 

### Install Anaconda

Install Anaconda from these instructions: https://linuxize.com/post/how-to-install-anaconda-on-ubuntu-20-04/

Close the terminal and start a new one to activate conda.

### Create and activate conda environment

Create and activate conda environment:
```shell
conda create -n paas  python=3.9 
conda activate paas
```

#### Install tilt
Install [tilt](https://docs.tilt.dev/install.html) via conda 

```shell
conda install -c conda-forge tilt 
conda install -c conda-forge minikube 
```

#### Start Cluster

```shell
minikube start
```

#### Run tilt

```shell
tilt up
```

# Encrypt secrets 


conda install -c conda-forge git-crypt


# Deploy Webapp
```
$make deploy-app
```


# Deploy API
```
$make deploy-api
```

# API Admin
To add/reomve resources go to: https://HOST/vre-api-test/admin/

## Admin Credentials
The admin credentials are generated by k8s/vreapis/secreats.yaml file with the value 'superuser-passwor'
The username is hardcoded in k8s/vreapis/deplyment.yaml in the env 'DJANGO_SUPERUSER_USERNAME'



# Argo Workflows

## Generate Token

```shell
kubectl apply -f - <<EOF
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: vre-api
  namespace: argo
rules:
  - verbs:
      - get
      - watch
      - patch
    apiGroups:
      - ''
    resources:
      - pods
  - verbs:
      - get
      - watch
    apiGroups:
      - ''
    resources:
      - pods/log
  - verbs:
      - create
    apiGroups:
      - ''
    resources:
      - pods/exec
  - verbs:
      - list
      - watch
      - create
      - get
      - update
      - delete
    apiGroups:
      - argoproj.io
    resources:
      - workflowtasksets
      - workflowartifactgctasks
      - workflowtemplates
      - workflows
  - verbs:
      - patch
    apiGroups:
      - argoproj.io
    resources:
      - workflowtasksets/status
      - workflowartifactgctasks/status
      - workflows/status
EOF
```

```shell
kubectl create sa vre-api -n argo
```

```shell
kubectl create rolebinding vre-api --role=vre-api --serviceaccount=argo:vre-api -n argo
```

```shell
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  namespace: argo
  name: vre-api.service-account-token
  annotations:
    kubernetes.io/service-account.name: vre-api
type: kubernetes.io/service-account-token
EOF
```

```shell
ARGO_TOKEN="Bearer $(kubectl get secret vre-api.service-account-token -n argo -o=jsonpath='{.data.token}' | base64 --decode)"
```

```shell
echo -n $ARGO_TOKEN | base64 -w 0
```


# Install GitGuardian pre-commit hook

```shell
pip install pre-commit
pre-commit install
pip install ggshield
ggshield auth login
//
```

